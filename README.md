# DIAG: A standardized metric for WGA quality control

DIAG toolkit provides scripts for estimating Depth of Independent Amplicons (DIA) metrics from VCF files. It consists of a pre-processing script to extract relevant allele depths and a calculation script to compute metrics and generate visualization reports.  
For bugs, suggestions, questions, collaborations etc. please contact [who?](mailto:email@address.cn)

## Scripts

1.  **`process_vcf.py`**: Parses a VCF file to extract allele depths for experiment samples at sites where the bulk sample is heterozygous.
2.  **`calc_eDIA.py`**: Calculates eDIA metrics, performs bootstrap analysis, and generates interactive HTML plots.

## Installation

1.  **Clone the repository:**

    ```bash
    git clone https://github.com/doorholez/DIAG.git
    cd DIAG
    ```

2.  **Install dependencies:**

    The scripts require Python 3 (>= 3.8) and the following libraries:

    -   numpy
    -   pandas
    -   scipy
    -   plotly
    -   natsort

    You can install them using pip:

    ```bash
    pip install numpy pandas scipy plotly natsort
    ```

## Usage

### 1. Pre-processing (`process_vcf.py`)

This script takes a VCF file as input. It assumes the **first sample** in the VCF is the "Bulk" sample. It identifies heterozygous sites in this reference sample and extracts the corresponding allele depths for all subsequent "Experiment" samples.

**Syntax:**

```bash
python process_vcf.py [options] <input_vcf>
```

**Arguments:**

*   `input_vcf`: Path to the input VCF file (supports `.vcf` and `.vcf.gz`).
*   `-p`, `--prefix`: Prefix string to add to output filenames.
*   `-f`, `--filter`: Filter string (e.g., `PASS`). Only variants with this exact value in the FILTER column are processed.
*   `-R`, `--region`: Limit processing to a specific genomic region (format: `chrom:start-end`).
*   `-d`, `--depth`: Minimum depth threshold. Sites with total depth lower than this value (in either bulk or experiment) are skipped.

**Output:**

Generates one text file per experiment sample named `{prefix}{SampleName}.txt`.
The file format is tab-separated:
```text
#chrom  pos     depth1  depth2
chr1    1000    20      15
...
```

### 2. Calculation & Visualization (`calc_eDIA.py`)

This script takes the text file generated by `process_vcf.py` and performs the eDIA calculation. You can generate your own input file if you have custom requirements. It splits the genome into regions, estimates allele frequencies and eDIA for both whole genome and regions, and produces an interactive HTML report.

**Syntax:**

```bash
python calc_eDIA.py [options] <input_file> [output_file]
```

**Arguments:**

*   `input_file`: Path to the input text file. See [**Input File Format**](#input-format) below.
*   `output_file`: (Optional) Path for the output HTML report. Defaults to `<input_filename>.html`.
*   `-r`, `--region_size`: Size of genomic regions to split for analysis (default: 10,000,000 bp).
*   `-b`, `--bootstrap`: Number of bootstrap iterations for whole-genome estimation (default: 1000).
*   `-br`, `--bootstrap_region`: Number of bootstrap iterations for split regions (default: 0.5 * global bootstrap).
*   `-q`, `--quiet`: Quiet mode (suppresses standard output, keeps warnings).
*   `-s`, `--silent`: Silent mode (suppresses all output).

<a id="input-format"></a>**Input File Format:**

The input file is a whitespace-separated text file. Lines starting with `#` are ignored. Each data line must contain 4 or 5 columns:

1.  `chrom`: Chromosome name.
2.  `pos`: Genomic position.
3.  `depth1`: Depth of the first allele (e.g., Reference depth).
4.  `depth2`: Depth of the second allele (e.g., Alternative depth).
5.  `ploidy`: (Optional) Local ploidy. Defaults to 2 if omitted.

Example:
```text
#chrom  pos     depth1  depth2  ploidy
chr1    1000    20      15      3
chr1    1050    10      12
```

**Output:**

An HTML file containing:
1.  **Whole Genome eDIA Bootstrap Distribution**: Density distribution plot of bootstrap results.
2.  **Copy Number & Allele Frequency**: Genomic tracks showing estimated allele frequency and ploidy.
3.  **Split Region eDIA**: Genomic track showing eDIA values with 95% confidence intervals.

## Example Workflow

```bash
# 1. Process the VCF file
# Extracts data for samples in 'variants.vcf.gz', filtering for 'PASS' variants
# and a minimum depth of 10. Output files will start with 'out_'.
python process_vcf.py variants.vcf.gz --prefix out_ --filter PASS --depth 10

# 2. Calculate eDIA for a specific sample
# Processes the output for 'SampleA' generated in the previous step.
python calc_eDIA.py out_SampleA.txt SampleA_report.html
```

## Feedback and Contribution

If you have any bug report, suggestion or question about the project, feel free to
- File an [issue](https://github.com/doorholez/DIAG/issues/new)
- Pull request
- Email me: doorholez@gmail.com

## Citation

when using DIAG please cite:
- what can I say?